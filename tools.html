<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard Generator</title>
  <style>
    body { font-family: sans-serif; max-width: 750px; margin: 40px auto; padding: 0 20px; background: #f5f5f5; }
    h1 { font-size: 1.4rem; }

    /* API Selector */
    #api-selector { background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; }
    #api-selector p { margin: 0 0 10px; font-weight: bold; font-size: 0.95rem; }
    .api-btns { display: flex; gap: 10px; flex-wrap: wrap; }
    .api-btn { padding: 10px 20px; border: 2px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 0.9rem; text-align: left; transition: all 0.2s; }
    .api-btn:hover { border-color: #2563eb; }
    .api-btn.selected-kass { border-color: #16a34a; background: #f0fdf4; }
    .api-btn.selected-fnio { border-color: #dc2626; background: #fef2f2; }
    .api-btn .api-name { font-weight: bold; font-size: 1rem; display: block; }
    .api-btn .api-tag-new { font-size: 0.75rem; color: #16a34a; font-weight: bold; }
    .api-btn .api-tag-old { font-size: 0.75rem; color: #dc2626; font-weight: bold; }
    .api-btn .api-desc { font-size: 0.78rem; color: #666; margin-top: 2px; display: block; }

    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { padding: 8px 20px; border: 2px solid #2563eb; background: white; color: #2563eb; border-radius: 6px; cursor: pointer; font-size: 0.95rem; }
    .tab.active { background: #2563eb; color: white; }
    label { font-weight: bold; display: block; margin: 12px 0 4px; }
    input[type=text] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
    input[type=file] { margin-top: 4px; }
    .hint { font-size: 0.8rem; color: #666; margin-top: 3px; }
    button.main { margin-top: 16px; padding: 12px 28px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }
    button.main:hover { background: #1d4ed8; }
    button.main:disabled { background: #93c5fd; cursor: not-allowed; }
    #output { margin-top: 16px; display: none; }
    #stats { background: #dcfce7; border: 1px solid #86efac; border-radius: 6px; padding: 10px 14px; margin-bottom: 10px; font-size: 0.9rem; }
    #stats.error { background: #fee2e2; border-color: #fca5a5; }
    textarea { width: 100%; height: 280px; font-family: monospace; font-size: 12px; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button.copy { background: #16a34a; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; margin-top: 6px; }
    .loader { display: none; margin-left: 12px; color: #2563eb; font-size: 0.9rem; }
    #api-badge { display: inline-block; margin-left: 10px; font-size: 0.78rem; padding: 2px 8px; border-radius: 20px; vertical-align: middle; }
    #api-badge.kass { background: #dcfce7; color: #16a34a; border: 1px solid #86efac; }
    #api-badge.fnio { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
  </style>
</head>
<body>
  <h1>‚ö° Leaderboard Generator</h1>

  <!-- API SELECTOR -->
  <div id="api-selector">
    <p>üîå Quelle API veux-tu utiliser ?</p>
    <div class="api-btns">
      <button class="api-btn selected-kass" id="btn-kass" onclick="selectApi('kass')">
        <span class="api-name">üü¢ Kass507.lat</span>
        <span class="api-tag-new">‚úÖ NOUVELLE M√âTHODE (recommand√©e)</span>
        <span class="api-desc">API priv√©e, plus rapide et fiable</span>
      </button>
      <button class="api-btn" id="btn-fnio" onclick="selectApi('fnio')">
        <span class="api-name">üî¥ FortniteAPI.io</span>
        <span class="api-tag-old">‚ö†Ô∏è ANCIENNE M√âTHODE</span>
        <span class="api-desc">API publique, peut √™tre moins stable</span>
      </button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="setMode('simple')" id="tab-simple">üèÜ Simple (1 jour)</button>
    <button class="tab" onclick="setMode('cumul')" id="tab-cumul">üìä Cumul√© (2 jours)</button>
  </div>

  <div id="mode-simple">
    <label>WindowID</label>
    <input type="text" id="wid1" placeholder="S39_SoloSeriesCupFinal_Day1_ME ou URL compl√®te">
    <div class="hint">üí° Colle l'URL Fortnite Tracker directement, le WindowID sera extrait automatiquement</div>
  </div>

  <div id="mode-cumul" style="display:none">
    <label>Day 1 ‚Äì WindowID</label>
    <input type="text" id="wid-d1" placeholder="S39_SoloSeriesCupFinal_Day1_ME ou URL">
    <label>Day 2 ‚Äì WindowID</label>
    <input type="text" id="wid-d2" placeholder="S39_SoloSeriesCupFinal_Day2_ME ou URL">
  </div>

  <label>fortnite_dict.txt <span style="font-weight:normal;color:#666">(optionnel ‚Äì pour les pseudos wiki)</span></label>
  <input type="file" id="dict-file" accept=".txt">

  <br>
  <button class="main" onclick="run()" id="run-btn">üöÄ G√©n√©rer</button>
  <span id="api-badge" class="kass">Kass507.lat</span>
  <span class="loader" id="loader">‚è≥ Chargement en cours...</span>

  <div id="output">
    <div id="stats"></div>
    <label>R√©sultat √† copier</label>
    <textarea id="result" readonly></textarea>
    <button class="copy" onclick="copyResult()" id="copy-btn">üìã Copier</button>
  </div>

  <script>
    const APIS = {
      kass: {
        base: "https://kass507.lat/api",
        key: "kass_A3u2Fle0YACnjklJwreWylDNRp-2beDZ",
        header: "x-api-key",
        successField: "success",
        tiebreakerPath: (session) => session?.rules?.tiebreakerFormula,
      },
      fnio: {
        base: "https://fortniteapi.io/v1",
        key: "370a899b-33b3ba08-a5299259-571d2ca1",
        header: "Authorization",
        successField: "result",
        tiebreakerPath: (session) => session?.rules?.tie,
      }
    };

    let currentApi = 'kass';
    let currentMode = 'simple';
    let dict = {};

    function selectApi(api) {
      currentApi = api;
      document.getElementById('btn-kass').className = 'api-btn' + (api === 'kass' ? ' selected-kass' : '');
      document.getElementById('btn-fnio').className = 'api-btn' + (api === 'fnio' ? ' selected-fnio' : '');
      const badge = document.getElementById('api-badge');
      if (api === 'kass') {
        badge.textContent = 'Kass507.lat';
        badge.className = 'kass';
      } else {
        badge.textContent = 'FortniteAPI.io';
        badge.className = 'fnio';
      }
      badge.id = 'api-badge';
    }

    function setMode(m) {
      currentMode = m;
      document.getElementById('mode-simple').style.display = m === 'simple' ? 'block' : 'none';
      document.getElementById('mode-cumul').style.display = m === 'cumul' ? 'block' : 'none';
      document.getElementById('tab-simple').classList.toggle('active', m === 'simple');
      document.getElementById('tab-cumul').classList.toggle('active', m === 'cumul');
    }

    function getWid(text) {
      text = text.trim();
      const m = text.match(/[?&]window=([a-zA-Z0-9_-]+)/);
      return m ? m[1] : text;
    }

    async function fetchPage(wid, page) {
      const api = APIS[currentApi];
      const url = `${api.base}/events/window?windowId=${encodeURIComponent(wid)}&page=${page}`;
      const r = await fetch(url, { headers: { [api.header]: api.key } });
      if (!r.ok) return null;
      return r.json();
    }

    async function fetchAll(wid) {
      const api = APIS[currentApi];
      let results = [], page = 0, tbFormula = null;
      while (true) {
        const data = await fetchPage(wid, page);
        if (!data || !data[api.successField]) break;
        if (page === 0) {
          const tb = api.tiebreakerPath(data.session);
          if (tb) tbFormula = tb;
        }
        results.push(...(data.session?.results || []));
        if (page >= (data.totalPages || 1) - 1) break;
        page++;
      }
      return { results, tbFormula };
    }

    function loadDict(text) {
      const d = {};
      for (const line of text.split('\n')) {
        if (!line.includes('=')) continue;
        const idx = line.indexOf('=');
        const pseudo = line.slice(0, idx).trim().replace(/_/g, ' ');
        const eid = line.slice(idx + 1).trim().toLowerCase();
        if (eid) d[eid] = pseudo;
      }
      return d;
    }

    function getName(m) {
      const eid = (m.id || '').toLowerCase();
      return dict[eid] || m.name || eid;
    }

    function formatLine(rank, members, points) {
      const parts = members.map(m => `${(m.id||'').toLowerCase()}{{!}}${getName(m)}`);
      return `${rank}\t${parts.join(',')}\t${points}`;
    }

    async function runSimple(wid) {
      const { results } = await fetchAll(wid);
      if (!results.length) return null;
      results.sort((a, b) => (a.rank || 999) - (b.rank || 999));
      return results.map((r, i) =>
        formatLine(r.rank || i + 1, r.teamAccountNames || [], r.pointsEarned || 0)
      );
    }

    async function runCumul(wids) {
      const players = {};
      let tbFormula = null;

      for (const wid of wids) {
        const { results, tbFormula: tf } = await fetchAll(wid);
        if (!tbFormula && tf) tbFormula = tf;
        for (const res of results) {
          const members = res.teamAccountNames || [];
          const key = members.map(m => (m.id||'').toLowerCase()).sort().join('|');
          if (!players[key]) players[key] = { points: 0, members, stats: {} };
          players[key].points += res.pointsEarned || 0;
          for (const session of (res.sessionHistory || [])) {
            for (const [stat, val] of Object.entries(session.trackedStats || {})) {
              if (!players[key].stats[stat]) players[key].stats[stat] = [];
              players[key].stats[stat].push(val);
            }
          }
        }
      }

      if (!tbFormula) tbFormula = { components: [
        { trackedStat: 'VICTORY_ROYALE_STAT', aggregation: 'sum', multiplier: 1 },
        { trackedStat: 'TEAM_ELIMS_STAT_INDEX', aggregation: 'sum', multiplier: 1 },
        { trackedStat: 'PLACEMENT_STAT_INDEX', aggregation: 'avg', multiplier: 1 }
      ]};

      const list = Object.values(players).map(p => ({
        ...p,
        tbValues: tbFormula.components.map(comp => {
          const vals = p.stats[comp.trackedStat] || [];
          if (!vals.length) return 0;
          const raw = comp.aggregation === 'avg'
            ? vals.reduce((a, b) => a + b, 0) / vals.length
            : vals.reduce((a, b) => a + b, 0);
          return raw * (comp.multiplier || 1);
        })
      }));

      list.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        for (let i = 0; i < a.tbValues.length; i++) {
          if (b.tbValues[i] !== a.tbValues[i]) return b.tbValues[i] - a.tbValues[i];
        }
        return 0;
      });

      return list.map((p, i) => formatLine(i + 1, p.members, p.points));
    }

    async function run() {
      const file = document.getElementById('dict-file').files[0];
      if (file) dict = loadDict(await file.text());

      const btn = document.getElementById('run-btn');
      const loader = document.getElementById('loader');
      btn.disabled = true;
      loader.style.display = 'inline';
      document.getElementById('output').style.display = 'none';

      try {
        let lines;
        if (currentMode === 'simple') {
          const wid = getWid(document.getElementById('wid1').value);
          if (!wid) { alert('Entre un WindowID !'); return; }
          lines = await runSimple(wid);
        } else {
          const d1 = getWid(document.getElementById('wid-d1').value);
          const d2 = getWid(document.getElementById('wid-d2').value);
          if (!d1 || !d2) { alert('Entre les deux WindowIDs !'); return; }
          lines = await runCumul([d1, d2]);
        }

        if (!lines) {
          document.getElementById('stats').className = 'error';
          document.getElementById('stats').textContent = '‚ùå Aucun r√©sultat ‚Äî v√©rifie le WindowID ou la connexion.';
        } else {
          const apiLabel = currentApi === 'kass' ? 'Kass507.lat' : 'FortniteAPI.io';
          const dictInfo = Object.keys(dict).length ? ` ¬∑ ${Object.keys(dict).length} pseudos charg√©s` : '';
          document.getElementById('stats').className = '';
          document.getElementById('stats').innerHTML = `‚úÖ <b>${lines.length} lignes g√©n√©r√©es</b> via ${apiLabel}${dictInfo}`;
          document.getElementById('result').value = lines.join('\n');
        }
        document.getElementById('output').style.display = 'block';
      } catch (e) {
        document.getElementById('stats').className = 'error';
        document.getElementById('stats').innerHTML = `‚ùå Erreur : ${e.message}<br><small>Si c'est une erreur CORS, ouvre le fichier via un serveur local (ex: VS Code Live Server).</small>`;
        document.getElementById('output').style.display = 'block';
      } finally {
        btn.disabled = false;
        loader.style.display = 'none';
      }
    }

    function copyResult() {
      navigator.clipboard.writeText(document.getElementById('result').value);
      document.getElementById('copy-btn').textContent = '‚úÖ Copi√© !';
      setTimeout(() => document.getElementById('copy-btn').textContent = 'üìã Copier', 2000);
    }
  </script>
</body>
</html>
